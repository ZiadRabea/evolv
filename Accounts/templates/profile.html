{%load static%}
{% load markdown_deux_tags %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{profile.user.first_name}} — Profile</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#EF7722',
            accent: '#0BA6DF',
            warm: '#FAA533',
            bgsoft: '#F8F8F8',
            neutralText: '#1E1E1E',
            red: '#F00',
          },
          borderRadius: {
            xl2: '18px'
          }
        }
      }
    }
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .card-shadow { box-shadow: 0 4px 14px rgba(0,0,0,0.06); }
    .hover-card:hover { transform: translateY(-3px); box-shadow: 0 8px 18px rgba(0,0,0,0.08); transition: all 0.2s ease; }
    .glass { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.8); }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 50; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .hide-scroll-bar::-webkit-scrollbar { display: none; }
    .hide-scroll-bar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>

<body class="bg-bgsoft text-neutralText">

  <!-- NAVBAR -->
  <nav class="glass fixed w-full top-0 left-0 z-40 border-b border-gray-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-gradient-to-br from-primary to-warm rounded-lg flex items-center justify-center text-white font-semibold text-base">
              E
            </div>
            <span class="font-semibold text-gray-800 text-lg">Evolv</span>
          </div>

          <div class="hidden md:flex items-center space-x-8">
            <a href="/" class="text-sm font-medium text-gray-600 hover:text-primary transition">Home</a>
            <a href="/planner" class="text-sm font-medium text-gray-600 hover:text-primary transition">Planner</a>
            <a href="/courses" class="text-sm font-medium text-gray-600 hover:text-primary transition">Grow</a>
            {%if user.is_authenticated%}
              {%if not user.profile == profile%}
                <a href="/in/{{user.profile.slug}}" class="text-sm font-medium text-gray-600 hover:text-primary transition">Profile</a>
              {%else%}
                <a href="/in/{{user.profile.slug}}" class="text-sm font-medium text-gray-600 border-b-2 border-primary">Profile</a>
              {%endif%}
            {%else%}
              <a href="/accounts/login" class="text-sm font-medium text-gray-600 hover:text-primary transition">Profile</a>
            {%endif%}
          </div>

          <div class="flex items-center gap-3">
            {%if user.is_authenticated and user.profile == profile%}
              <a href="/update_profile"><button class="px-4 py-1.5 bg-primary text-white rounded-lg text-sm font-medium hover:opacity-90 transition"><i class = "fas fa-pen"></i> Edit</button></a>
            {%else%}
              <a href="/"><button class="px-4 py-1.5 bg-primary text-white rounded-lg text-sm font-medium hover:opacity-90 transition"><i class = "fas fa-home"></i> Home</button></a>
            {%endif%}
          </div>
        </div>
      </div>
    </nav>

  <!-- MAIN -->
  <main class="pt-24 pb-16 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 space-y-8">

    <!-- HEADER / HERO -->
    <section class="relative">
      <div class="w-full h-52 bg-gradient-to-r from-accent to-primary rounded-xl2"></div>

      <!-- Profile Card -->
      <div class="relative -mt-20 bg-white rounded-xl2 p-6 card-shadow flex flex-col sm:flex-row sm:items-start gap-6">
        {%if profile.profile_pic%}
          <img src="{{profile.profile_pic.url}}" class="w-32 h-32 rounded-full border-4 border-white shadow-md object-cover -mt-12 sm:mt-0" onerror="this.onerror=null; this.src='{% static 'imgs/profile_placeholder.png' %}';">
        {%else%}
          <img src="{%static 'imgs/profile_placeholder.png'%}" class="w-32 h-32 rounded-full border-4 border-white shadow-md object-cover -mt-12 sm:mt-0">
        {%endif%}
        <div class="flex-1">
          <h1 class="font-semibold text-2xl text-gray-800">{{profile.user.first_name}}</h1>
          <p class="text-sm text-gray-500">{{profile.job_title}}</p>
          <p class="text-sm text-gray-600 mt-3 leading-relaxed max-w-xl">
            {{profile.bio}}
          </p>

          <!-- Social links -->
          <div class="flex gap-4 mt-4 text-gray-500 text-lg">
            {%if profile.linkedin%}
              <a href="{{profile.linkedin}}" class="hover:text-accent transition"><i class="fa-brands fa-linkedin"></i></a>
            {%endif%}
            {%if profile.github%}  
              <a href="{{profile.github}}" class="hover:text-gray-800 transition"><i class="fa-brands fa-github"></i></a>
            {%endif%}
            {%if profile.twitter%}
              <a href="{{profile.twitter}}" class="hover:text-primary transition"><i class="fa-brands fa-x-twitter"></i></a>
            {%endif%}
            {%if profile.youtube%}
              <a href="{{profile.youtube}}" class="hover:text-red transition"><i class="fa-brands fa-youtube"></i></a>
            {%endif%}
          </div>
        </div>

        <!-- Actions -->
        <div class="flex gap-3 sm:ml-auto self-end">
          {%if user.is_authenticated%}
            {%if not user.profile in profile.followers.all%}
              <a href="/in/{{profile.slug}}/follow">
                <button class="bg-accent text-white text-sm px-4 py-1.5 rounded-lg hover:opacity-90 transition">
                  <i class="fa-solid fa-user-plus mr-1"></i> Follow
                </button>
              </a>
            {%else%}
              <a href="/in/{{profile.slug}}/follow">
                <button class="bg-primary text-white text-sm px-4 py-1.5 rounded-lg hover:opacity-90 transition">
                  <i class="fa-solid fa-user-minus mr-1"></i> Unfollow
                </button>
              </a>
            {%endif%}
          {%else%}
          <a href="/accounts/login?next=/in/{{profile.slug}}/follow">
            <button class="bg-accent text-white text-sm px-4 py-1.5 rounded-lg hover:opacity-90 transition">
              <i class="fa-solid fa-user-plus mr-1"></i> Follow
            </button>
          </a>
          {%endif%}
          <a href="/in/{{profile.slug}}/chat"><button class="bg-white border border-gray-300 text-sm px-4 py-1.5 rounded-lg hover:border-accent hover:text-accent transition">
            <i class="fa-solid fa-envelope mr-1"></i> Message
          </button></a>
        </div>
      </div>
    </section>

    <!-- ABOUT -->
    <section class="bg-white rounded-xl2 p-6 card-shadow hover-card">
      <h2 class="font-semibold text-lg mb-3">About</h2>
      <p class="text-gray-700 text-sm leading-relaxed">
        {{profile.bio}}
      </p>

      <div class="flex flex-wrap gap-3 mt-4">
        {%for skill in profile.skills%}
          <span class="px-3 py-1 bg-bgsoft border border-gray-200 rounded-full text-xs text-gray-600">{{skill}}</span>
        {%endfor%}
      </div>
    </section>

    <!-- PROJECTS -->
    <section class="bg-white rounded-xl2 p-6 card-shadow hover-card">
      <div class="flex justify-between items-center mb-4">
        <h2 class="font-semibold text-lg">Projects</h2>
        <a href="/in/{{profile.slug}}/projects" class="text-sm text-accent hover:underline">View all</a>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
        {% if request.user == profile.user %}
          {# Show only 2 projects for the owner #}
          {% for project in profile.project_set.all|slice:":2" %}
            <div class="rounded-xl2 overflow-hidden border border-gray-100 card-shadow hover-card">
              {% if project.image %}
                <img src="{{ project.image.url }}" class="w-full h-40 object-cover">
              {% else %}
                <img src="{% static 'project_placeholder.png' %}" class="w-full h-40 object-cover">
              {% endif %}

              <div class="p-4">
                <h3 class="font-medium text-gray-800 text-sm">{{ project.title }}</h3>
                <p class="text-xs text-gray-500 mt-1">{{ project.description }}</p>

                {% if project.tech %}
                  <div class="flex flex-wrap gap-2 mt-3">
                    {% for tech in project.tech %}
                      <span class="px-2 py-1 bg-indigo-50 text-indigo-600 text-xs font-medium rounded-full border border-indigo-100">
                        {{ tech }}
                      </span>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          {% endfor %}

          {# Add Project Card #}
          <div id="openProjectModal" 
            class="flex flex-col items-center justify-center rounded-xl2 border-2 border-dashed border-gray-300 
                  hover:border-indigo-500 transition p-6 cursor-pointer text-center">
            <div class="text-4xl text-indigo-500 font-bold">+</div>
            <p class="mt-2 text-sm text-gray-600">Add New Project</p>
          </div>

        {% else %}
          {# Show all projects for visitors (limit 3 for layout) #}
          {% for project in profile.project_set.all|slice:":3" %}
            <div class="rounded-xl2 overflow-hidden border border-gray-100 card-shadow hover-card">
              {% if project.image %}
                <img src="{{ project.image.url }}" class="w-full h-40 object-cover">
              {% else %}
                <img src="{% static 'project_placeholder.png' %}" class="w-full h-40 object-cover">
              {% endif %}

              <div class="p-4">
                <h3 class="font-medium text-gray-800 text-sm">{{ project.title }}</h3>
                <p class="text-xs text-gray-500 mt-1">{{ project.description }}</p>

                {% if project.tech %}
                  <div class="flex flex-wrap gap-2 mt-3">
                    {% for tech in project.tech %}
                      <span class="px-2 py-1 bg-indigo-50 text-indigo-600 text-xs font-medium rounded-full border border-indigo-100">
                        {{ tech }}
                      </span>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        {% endif %}
      </div>
    </section>


    <!-- POSTS -->
    {%if post%}
    <section class="bg-white rounded-xl2 p-6 card-shadow hover-card space-y-5">
      <h2 class="font-semibold text-lg">Recent Posts</h2>

      <article class="border-t pt-4">
        <div class="flex items-center gap-3 mb-2">
          {%if profile.profile_pic%}
            <img src="{{profile.profile_pic.url}}" class="w-9 h-9 rounded-full">
          {%else%}
            <img src="{%static 'imgs/profile_placeholder.png'%}" class="w-9 h-9 rounded-full">
          {%endif%}
          <div>
            <div class="font-medium text-sm">{{profile.user.first_name}}</div>
            <div class="text-xs text-gray-500">{{post.date|timesince}} • ago | {{post.audience}}</div>
          </div>
        </div>
        <p class="text-sm text-gray-700">
          {{post.text|markdown}}
        </p>
        {%if post.poster%}
          <img src="{{post.poster.url}}" class="mt-3 rounded-lg w-full object-cover">
        {%endif%}
        <div class="flex items-center justify-between pt-3 text-sm text-gray-500">
            <div class="flex items-center gap-6">
              <a href="post/{{post.id}}/like">
                <button class="hover:text-primary flex items-center gap-1 transition">
                  {%if user.is_authenticated and user.profile in post.likes.all%}
                    <i onclick="this.style.color='#a0aec0'" style="color: red;" class="fa-regular fa-heart"></i> 
                  {%else%}
                    <i onclick="this.style.color='red'" class="fa-regular fa-heart"></i> 
                  {%endif%}
                  <span>{{post.likes.count}}</span>
                </button>
              </a>
              <button class="hover:text-accent flex items-center gap-1 transition">
                <i class="fa-regular fa-comment"></i> <span>{{post.comment_set.count}}</span>
              </button>
            </div>
            <button class="hover:text-gray-700 transition flex items-center gap-1">
              <i class="fa-solid fa-share"></i> Share
            </button>
          </div>
      </article>
    </section>
    {%endif%}

    <div id="projectModal" class="modal">
    <div class="bg-white rounded-xl2 p-6 w-full max-w-md mx-auto card-shadow relative">
      <button id="closeProjectModal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-xl leading-none">&times;</button>
      <h2 class="font-semibold text-gray-800 text-lg mb-4">Add New Project</h2>

      <form id="projectForm" class="space-y-4" method="post" enctype="multipart/form-data">
        {%csrf_token%}
        <input type="text" name="title" placeholder="Project Title" class="w-full border border-gray-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-accent" required>
        <textarea placeholder="Short Description" name="description" rows="3" class="w-full border border-gray-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-accent" required></textarea>

        <!-- Upload -->
        <div class="relative w-full">
          <label class="block text-sm text-gray-700 mb-1">Thumbnail</label>
          <div id="projectImagePreview" class="w-full h-40 bg-bgsoft rounded-lg border border-gray-200 flex flex-col items-center justify-center cursor-pointer hover:border-accent transition">
            <i class="fa-solid fa-plus text-gray-400 text-2xl mb-2"></i>
            <span class="text-gray-500 text-sm">Click to upload image</span>
          </div>
          <input type="file" id="projectImage" name="image" accept="image/*" class="hidden">
        </div>

        <!-- Tech Tags -->
        <div>
          <label class="block text-sm text-gray-700 mb-1">Technologies</label>
          <div id="techTags" class="flex flex-wrap gap-2 p-2 border border-gray-200 rounded-lg bg-bgsoft">
            <input type="text" id="techInput" placeholder="Add tech..." class="flex-1 bg-transparent text-sm focus:outline-none" />
            <input type="hidden" name="tech" id="techHiddenInput">
          </div>
        </div>

        <div class="flex justify-end">
          <button type="submit" class="bg-primary text-white text-sm px-5 py-1.5 rounded-lg hover:opacity-90 transition">Add Project</button>
        </div>
      </form>
    </div>
  </div>
  </main>
  <script>
    // ======== Modal Controls ========
    const projectModal = document.getElementById('projectModal');
    const openProjectModal = document.getElementById('openProjectModal');
    const closeProjectModal = document.getElementById('closeProjectModal');

    if (openProjectModal && closeProjectModal && projectModal) {
      openProjectModal.addEventListener('click', () => projectModal.classList.add('active'));
      closeProjectModal.addEventListener('click', () => projectModal.classList.remove('active'));
      projectModal.addEventListener('click', e => {
        if (e.target === projectModal) projectModal.classList.remove('active');
      });
    }

    // ======== Image Upload Preview ========
    const imageInput = document.getElementById('projectImage');
    const imagePreview = document.getElementById('projectImagePreview');

    if (imageInput && imagePreview) {
      imagePreview.addEventListener('click', () => imageInput.click());
      imageInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = ev => {
            imagePreview.innerHTML = `
              <img src="${ev.target.result}" class="w-full h-full object-cover rounded-lg">
            `;
          };
          reader.readAsDataURL(file);
        }
      });
    }

    // ======== Tech Tags System ========
    const techInput = document.getElementById('techInput');
    const techTags = document.getElementById('techTags');
    const techHiddenInput = document.getElementById('techHiddenInput');
    const projectForm = document.getElementById('projectForm');

    // sanitize raw tag string
    function sanitizeTag(raw) {
      if (!raw) return '';
      return raw.replace(/,/g, '').trim();
    }

    // get list of tag values
    function getCurrentTags() {
      return Array.from(techTags.querySelectorAll('[data-tag]'))
        .map(el => el.dataset.tag)
        .filter(Boolean);
    }

    // update hidden input value (comma-separated)
    function updateHiddenInput() {
      const tags = getCurrentTags();
      techHiddenInput.value = tags.join(',');
    }

    // create a tag chip
    function createTagChip(tagText) {
      const sanitized = sanitizeTag(tagText);
      if (!sanitized) return;

      // prevent duplicate
      const existing = getCurrentTags();
      if (existing.includes(sanitized)) return;

      const chip = document.createElement('span');
      chip.className =
        'flex items-center gap-1 px-2 py-0.5 bg-white border border-gray-200 rounded-full text-xs';
      chip.setAttribute('data-tag', sanitized);

      const text = document.createElement('span');
      text.textContent = sanitized;
      text.className = 'truncate';

      const remove = document.createElement('i');
      remove.className = 'fa-solid fa-xmark text-gray-400 cursor-pointer text-[10px]';
      remove.addEventListener('click', () => {
        chip.remove();
        updateHiddenInput();
      });

      chip.appendChild(text);
      chip.appendChild(remove);
      techTags.insertBefore(chip, techInput);
      updateHiddenInput();
    }

    // handle Enter and comma key
    if (techInput) {
      techInput.addEventListener('keydown', e => {
        if ((e.key === 'Enter' || e.key === ',') && techInput.value.trim() !== '') {
          e.preventDefault();
          createTagChip(techInput.value);
          techInput.value = '';
        }
      });

      // handle pasted comma-separated tags
      techInput.addEventListener('paste', e => {
        const pasted = (e.clipboardData || window.clipboardData).getData('text');
        if (pasted && pasted.includes(',')) {
          e.preventDefault();
          pasted
            .split(',')
            .map(sanitizeTag)
            .filter(Boolean)
            .forEach(tag => createTagChip(tag));
        }
      });
    }

    // update before submit
    if (projectForm) {
      projectForm.addEventListener('submit', e => {
        updateHiddenInput();
        // Optional: log to check value
        // console.log('Submitting technologies:', techHiddenInput.value);
      });
    }

    // ======== Optional: load initial tags (for edit mode) ========
    // Example: populateTagsFromString("Django,React,Tailwind");
    function populateTagsFromString(csv) {
      if (!csv) return;
      csv.split(',')
        .map(sanitizeTag)
        .filter(Boolean)
        .forEach(tag => createTagChip(tag));
    }
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll('.fa-share').forEach(btn => {
        btn.addEventListener('click', function (e) {
          e.preventDefault();
          const postElement = btn.closest('article');
          const postId = "{{post.id}}"
          const shareUrl = `${window.location.origin}/post/${postId}`;
          
          if (navigator.share) {
            navigator.share({
              title: 'Check out this post on Evolv',
              url: shareUrl
            }).catch(err => console.log('Share canceled', err));
          } else {
            navigator.clipboard.writeText(shareUrl).then(() => {
              alert('Post link copied to clipboard!');
            });
          }
        });
      });
    });
  </script>

</body>
</html>
