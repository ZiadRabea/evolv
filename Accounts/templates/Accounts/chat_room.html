{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat — {{ other_profile.user.first_name }}</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" />

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#EF7722',
            accent: '#0BA6DF',
            warm: '#FAA533',
            bgsoft: '#F8F8F8',
            neutralText: '#1E1E1E',
            red: '#F00',
          },
          borderRadius: { xl2: '18px' },
          boxShadow: {
            soft: '0 4px 14px rgba(0,0,0,0.06)',
            input: '0 2px 6px rgba(11,166,223,0.15)',
          },
        }
      }
    }
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .hide-scroll-bar::-webkit-scrollbar { display: none; }
    .hide-scroll-bar { -ms-overflow-style: none; scrollbar-width: none; }
    .fade-in { animation: fadeIn 0.25s ease-in; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Hide textarea scrollbar */
    textarea::-webkit-scrollbar { display: none; }
    textarea { scrollbar-width: none; -ms-overflow-style: none; }

    /* Smooth height transition */
    textarea {
      transition: height 0.15s ease, box-shadow 0.15s ease;
    }
  </style>
</head>
<body class="bg-bgsoft text-neutralText min-h-screen">
    <nav class="glass fixed w-full top-0 left-0 z-30 border-b border-gray-200 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 bg-gradient-to-br from-primary to-warm rounded-lg flex items-center justify-center text-white font-semibold text-base">
            E
          </div>
          <span class="font-semibold text-gray-800 text-lg">Evolv</span>
        </div>

        <div class="hidden md:flex items-center space-x-8">
            <a href="/" class="text-sm font-medium text-gray-600 hover:text-primary transition">Home</a>
            <a href="/planner" class="text-sm font-medium text-gray-600 hover:text-primary transition">Planner</a>
            <a href="#" class="text-sm font-medium text-gray-600 hover:text-primary transition">Grow</a>
            {%if user.is_authenticated%}
              <a href="/in/{{user.profile.slug}}" class="text-sm font-medium text-gray-600 hover:text-primary transition">Profile</a>
            {%else%}
              <a href="/accounts/login" class="text-sm font-medium text-gray-600 hover:text-primary transition">Profile</a>
            {%endif%}
        </div>
        <a href="/"><button class="px-4 py-1.5 bg-primary text-white rounded-lg text-sm font-medium hover:opacity-90 transition">Home <i class="fas fa-home"></i> </button></a>
      </div>
    </div>
  </nav>
  <!-- Main Layout -->
  <div class="flex pt-16">
    <!-- Profile Sidebar -->
    <aside class="hidden lg:flex flex-col max-h-[calc(100vh-65px)] items-center text-center bg-white border-l border-gray-100 shadow-soft w-80 h-screen p-6 sticky top-0">
      {% if other_profile.profile_pic %}
        <img src="{{ other_profile.profile_pic.url }}" class="w-24 h-24 rounded-full object-cover border-4 border-white shadow-md">
      {% else %}
        <img src="{% static 'imgs/profile_placeholder.png' %}" class="w-24 h-24 rounded-full object-cover border-4 border-white shadow-md">
      {% endif %}
      <h2 class="mt-3 font-semibold text-gray-800 text-lg">{{ other_profile.user.first_name }}</h2>
      <p class="text-sm text-gray-500">{{ other_profile.job_title }}</p>
      <p class="text-xs text-gray-600 mt-2 leading-relaxed max-w-xs">{{ other_profile.bio|truncatewords:20 }}</p>

      <!-- Social Links -->
      <div class="flex gap-4 mt-4 text-gray-500 text-lg">
        {% if other_profile.linkedin %}
          <a href="{{ other_profile.linkedin }}" class="hover:text-accent transition"><i class="fa-brands fa-linkedin"></i></a>
        {% endif %}
        {% if other_profile.github %}
          <a href="{{ other_profile.github }}" class="hover:text-gray-800 transition"><i class="fa-brands fa-github"></i></a>
        {% endif %}
        {% if other_profile.twitter %}
          <a href="{{ other_profile.twitter }}" class="hover:text-primary transition"><i class="fa-brands fa-x-twitter"></i></a>
        {% endif %}
        {% if other_profile.youtube %}
          <a href="{{ other_profile.youtube }}" class="hover:text-red transition"><i class="fa-brands fa-youtube"></i></a>
        {% endif %}
      </div>

      <!-- Skills -->
      {% if other_profile.skills %}
      <div class="mt-6 w-full">
        <h3 class="font-semibold text-sm mb-2 text-gray-700 text-left">Skills</h3>
        <div class="flex flex-wrap gap-2">
          {% for skill in other_profile.skills %}
            <span class="px-3 py-1 bg-bgsoft border border-gray-200 rounded-full text-xs text-gray-600">{{ skill }}</span>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </aside>
    <!-- Chat Section -->
    <main class="flex-1 flex flex-col h-[calc(100vh-65px)] bg-white border-l border-gray-100 shadow-soft p-5 lg:p-8 overflow-hidden">

      <!-- Chat Header -->
      <div class="flex items-center justify-between pb-4 border-b border-gray-100">
        <div class="flex items-center gap-3">
          <a href="/in/{{ other_profile.slug }}" 
             class="text-gray-500 hover:text-primary transition text-lg">
            <i class="fa-solid fa-arrow-left"></i>
          </a>

          {% if other_profile.profile_pic %}
            <img src="{{ other_profile.profile_pic.url }}" class="w-12 h-12 rounded-full object-cover border border-gray-200">
          {% else %}
            <img src="{% static 'imgs/profile_placeholder.png' %}" class="w-12 h-12 rounded-full object-cover border border-gray-200">
          {% endif %}

          <div>
            <div class="font-semibold text-gray-800 text-lg">{{ other_profile.user.first_name }}</div>
            <div class="text-xs text-gray-500">Private conversation</div>
          </div>
        </div>
      </div>

      <!-- Chat Messages -->
      <div id="chat-box" class="flex-1 mt-4 overflow-y-auto hide-scroll-bar space-y-3 scroll-smooth pr-1">
        {% for message in messages %}
          {% if message.sender.user == request.user %}
            <div class="flex justify-end fade-in">
              <div class="bg-gradient-to-tr from-primary to-warm text-white px-4 py-2 rounded-xl2 max-w-xs text-sm shadow-md">
                {{ message.content|linebreaksbr }}
                <div class="text-[10px] opacity-70 text-right mt-1">{{ message.timestamp|date:"H:i" }}</div>
              </div>
            </div>
          {% else %}
            <div class="flex justify-start fade-in">
              <div class="bg-bgsoft text-gray-800 border border-gray-200 px-4 py-2 rounded-xl2 max-w-xs text-sm shadow-sm">
                {{ message.content|linebreaksbr }}
                <div class="text-[10px] opacity-70 text-right mt-1">{{ message.timestamp|date:"H:i" }}</div>
              </div>
            </div>
          {% endif %}
        {% empty %}
          <div class="text-center text-gray-400 mt-6 italic">No messages yet — say hi 👋</div>
        {% endfor %}
      </div>

      <!-- Chat Input -->
      <form id="chat-form" class="relative mt-4" onsubmit="return false;">
        <div class="relative bg-bgsoft border border-gray-200 rounded-xl2 px-4 shadow-input focus-within:ring-2 focus-within:ring-accent transition">
          <textarea id="message-input" rows="1" placeholder="Type a message..."
            class="w-full resize-none bg-transparent py-3 pr-10 text-sm leading-relaxed focus:outline-none"
            autocomplete="off"></textarea>
          <button id="send-btn" type="button"
            class="absolute right-3 top-1/2 -translate-y-1/2 text-accent hover:text-primary transition">
            <i class="fa-solid fa-paper-plane text-lg"></i>
          </button>
        </div>
      </form>

    </main>
  </div>

  <!-- Script -->
  <script>
    const otherSlug = "{{ other_profile.slug }}";
    const username = "{{ request.user.username }}"; 
    const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
    const wsUrl = `${wsProtocol}://${window.location.host}/ws/Accounts/${otherSlug}/`;
    const socket = new WebSocket(wsUrl);

    const chatBox = document.getElementById('chat-box');
    const input = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');

    // Auto resize textarea
    input.addEventListener('input', () => {
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 180) + 'px';
    });

    socket.onopen = () => console.log('%c✅ WebSocket connected', 'color: green');
    socket.onclose = (e) => console.log('%c❌ WebSocket closed', 'color: red', e);
    socket.onerror = (err) => console.error('WebSocket error', err);

    socket.onmessage = (e) => {
      const data = JSON.parse(e.data);
      if (data.sender === username) return;
      appendMessage(data, false);
    };

    function appendMessage(data, self = false) {
      const wrapper = document.createElement('div');
      wrapper.className = self ? 'flex justify-end fade-in' : 'flex justify-start fade-in';

      const bubble = document.createElement('div');
      bubble.className = self
        ? "bg-gradient-to-tr from-primary to-warm text-white px-4 py-2 rounded-xl2 max-w-xs text-sm shadow-md"
        : "bg-bgsoft text-gray-800 border border-gray-200 px-4 py-2 rounded-xl2 max-w-xs text-sm shadow-sm";

      bubble.innerHTML = `${escapeHtml(data.message)}
        <div class="text-[10px] opacity-70 text-right mt-1">
          ${new Date(data.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
        </div>`;

      wrapper.appendChild(bubble);
      chatBox.appendChild(wrapper);
      chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: "smooth" });
    }

    function escapeHtml(unsafe) {
      return unsafe.replaceAll('&','&amp;')
                   .replaceAll('<','&lt;')
                   .replaceAll('>','&gt;')
                   .replaceAll('"','&quot;')
                   .replaceAll("'", '&#039;');
    }

    function sendMessage(){
      const text = input.value.trim();
      if (!text || socket.readyState !== WebSocket.OPEN) return;
      const payload = { message: text, sender: username, timestamp: new Date().toISOString() };
      appendMessage(payload, true);
      socket.send(JSON.stringify({ message: text }));
      input.value = '';
      input.style.height = 'auto';
    }

    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keydown', (e) => {
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        sendMessage();
      }
    });
    window.addEventListener('load', () => {
      chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'auto' });
    });
  </script>
</body>
</html>
