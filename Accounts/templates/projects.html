{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ profile.user.first_name }} — Projects</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" />

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#EF7722',
            accent: '#0BA6DF',
            warm: '#FAA533',
            bgsoft: '#F8F8F8',
            neutralText: '#1E1E1E',
            red: '#F00',
          },
          borderRadius: { xl2: '18px' }
        }
      }
    }
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .card-shadow { box-shadow: 0 4px 14px rgba(0,0,0,0.06); }
    .hover-card:hover { transform: translateY(-3px); box-shadow: 0 8px 18px rgba(0,0,0,0.08); transition: all 0.2s ease; }
    .glass { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.8); }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 50; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
  </style>
</head>

<body class="bg-bgsoft text-neutralText">

  <!-- NAVBAR -->
  <nav class="glass fixed w-full top-0 left-0 z-30 border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 bg-gradient-to-br from-primary to-warm rounded-lg flex items-center justify-center text-white font-semibold text-base">E</div>
          <span class="font-semibold text-gray-800 text-lg">Evolv</span>
        </div>

        <div class="hidden md:flex items-center space-x-8">
            <a href="/" class="text-sm font-medium text-gray-600 hover:text-primary transition">Home</a>
            <a href="/planner" class="text-sm font-medium text-gray-600 hover:text-primary transition">Planner</a>
            <a href="#" class="text-sm font-medium text-gray-600 hover:text-primary transition">Grow</a>
            {%if user.is_authenticated%}
              <a href="/in/{{user.profile.slug}}" class="text-sm font-medium text-gray-600 hover:text-primary transition">Profile</a>
            {%else%}
              <a href="/accounts/login" class="text-sm font-medium text-gray-600 hover:text-primary transition">Profile</a>
            {%endif%}
        </div>

        {% if user.profile == profile %}
        <button id="openProjectModal" class="px-4 py-1.5 bg-primary text-white rounded-lg text-sm font-medium hover:opacity-90 transition">
          + Add Project
        </button>
        {% endif %}
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="pt-24 pb-16 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 space-y-10">

    <header class="flex justify-between items-center">
      <h1 class="text-2xl font-semibold text-gray-800">{{ profile.user.first_name }}’s Projects</h1>
      {% if user.profile == profile %}
        <p class="text-sm text-gray-500">Manage or delete your projects</p>
      {% endif %}
    </header>

    <!-- PROJECT GRID -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for project in profile.project_set.all %}
      <div class="rounded-xl2 overflow-hidden border border-gray-100 card-shadow hover-card relative">
        {% if user.profile == profile %}
          <!-- Delete Button -->
          <div class="absolute top-2 right-2 z-10">
            <a href="/projects/{{project.id}}/delete" class="bg-white/90 hover:bg-red-100 text-red-500 text-xs px-2 py-1 rounded-md shadow-sm">
              <i class="fa-solid fa-trash"></i>
            </a>
          </div>
        {% endif %}

        {% if project.image %}
          <img src="{{ project.image.url }}" class="w-full h-44 object-cover">
        {% else %}
          <img src="{% static 'project_placeholder.png' %}" class="w-full h-44 object-cover">
        {% endif %}

        <div class="p-4">
          <h3 class="font-medium text-gray-800 text-base">{{ project.title }}</h3>
          <p class="text-xs text-gray-500 mt-1 line-clamp-2">{{ project.description }}</p>

          {% if project.tech %}
          <div class="flex flex-wrap gap-2 mt-3">
            {% for tech in project.tech %}
              <span class="px-2 py-1 bg-indigo-50 text-indigo-600 text-xs font-medium rounded-full border border-indigo-100">
                {{ tech }}
              </span>
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </div>
      {% empty %}
        <p class="text-gray-500 text-sm col-span-full text-center py-8">No projects yet.</p>
      {% endfor %}
    </section>

  </main>

  <!-- ADD PROJECT MODAL (copied exactly from profile page) -->
  <div id="projectModal" class="modal">
    <div class="bg-white rounded-xl2 p-6 w-full max-w-md mx-auto card-shadow relative">
      <button id="closeProjectModal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-xl leading-none">&times;</button>
      <h2 class="font-semibold text-gray-800 text-lg mb-4">Add New Project</h2>

      <form id="projectForm" class="space-y-4" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="text" name="title" placeholder="Project Title" class="w-full border border-gray-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-accent" required>
        <textarea placeholder="Short Description" name="description" rows="3" class="w-full border border-gray-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-accent" required></textarea>

        <!-- Upload -->
        <div class="relative w-full">
          <label class="block text-sm text-gray-700 mb-1">Thumbnail</label>
          <div id="projectImagePreview" class="w-full h-40 bg-bgsoft rounded-lg border border-gray-200 flex flex-col items-center justify-center cursor-pointer hover:border-accent transition">
            <i class="fa-solid fa-plus text-gray-400 text-2xl mb-2"></i>
            <span class="text-gray-500 text-sm">Click to upload image</span>
          </div>
          <input type="file" id="projectImage" name="image" accept="image/*" class="hidden">
        </div>

        <!-- Tech Tags -->
        <div>
          <label class="block text-sm text-gray-700 mb-1">Technologies</label>
          <div id="techTags" class="flex flex-wrap gap-2 p-2 border border-gray-200 rounded-lg bg-bgsoft">
            <input type="text" id="techInput" placeholder="Add tech..." class="flex-1 bg-transparent text-sm focus:outline-none" />
            <input type="hidden" name="tech" id="techHiddenInput">
          </div>
        </div>

        <div class="flex justify-end">
          <button type="submit" class="bg-primary text-white text-sm px-5 py-1.5 rounded-lg hover:opacity-90 transition">Add Project</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ======== Modal Controls ========
    const projectModal = document.getElementById('projectModal');
    const openProjectModal = document.getElementById('openProjectModal');
    const closeProjectModal = document.getElementById('closeProjectModal');
    if (openProjectModal && closeProjectModal && projectModal) {
      openProjectModal.addEventListener('click', () => projectModal.classList.add('active'));
      closeProjectModal.addEventListener('click', () => projectModal.classList.remove('active'));
      projectModal.addEventListener('click', e => { if (e.target === projectModal) projectModal.classList.remove('active'); });
    }

    // ======== Image Upload Preview ========
    const imageInput = document.getElementById('projectImage');
    const imagePreview = document.getElementById('projectImagePreview');
    if (imageInput && imagePreview) {
      imagePreview.addEventListener('click', () => imageInput.click());
      imageInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = ev => {
            imagePreview.innerHTML = `<img src="${ev.target.result}" class="w-full h-full object-cover rounded-lg">`;
          };
          reader.readAsDataURL(file);
        }
      });
    }

    // ======== Tech Tags System ========
    const techInput = document.getElementById('techInput');
    const techTags = document.getElementById('techTags');
    const techHiddenInput = document.getElementById('techHiddenInput');
    const projectForm = document.getElementById('projectForm');

    function sanitizeTag(raw) { return raw ? raw.replace(/,/g, '').trim() : ''; }
    function getCurrentTags() {
      return Array.from(techTags.querySelectorAll('[data-tag]')).map(el => el.dataset.tag).filter(Boolean);
    }
    function updateHiddenInput() { techHiddenInput.value = getCurrentTags().join(','); }

    function createTagChip(tagText) {
      const sanitized = sanitizeTag(tagText);
      if (!sanitized) return;
      if (getCurrentTags().includes(sanitized)) return;
      const chip = document.createElement('span');
      chip.className = 'flex items-center gap-1 px-2 py-0.5 bg-white border border-gray-200 rounded-full text-xs';
      chip.setAttribute('data-tag', sanitized);
      const text = document.createElement('span');
      text.textContent = sanitized;
      const remove = document.createElement('i');
      remove.className = 'fa-solid fa-xmark text-gray-400 cursor-pointer text-[10px]';
      remove.addEventListener('click', () => { chip.remove(); updateHiddenInput(); });
      chip.appendChild(text); chip.appendChild(remove);
      techTags.insertBefore(chip, techInput);
      updateHiddenInput();
    }

    if (techInput) {
      techInput.addEventListener('keydown', e => {
        if ((e.key === 'Enter' || e.key === ',') && techInput.value.trim() !== '') {
          e.preventDefault();
          createTagChip(techInput.value);
          techInput.value = '';
        }
      });
      techInput.addEventListener('paste', e => {
        const pasted = (e.clipboardData || window.clipboardData).getData('text');
        if (pasted && pasted.includes(',')) {
          e.preventDefault();
          pasted.split(',').map(sanitizeTag).filter(Boolean).forEach(tag => createTagChip(tag));
        }
      });
    }
    if (projectForm) {
      projectForm.addEventListener('submit', () => updateHiddenInput());
    }
  </script>
</body>
</html>
