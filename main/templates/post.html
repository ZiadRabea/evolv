{%load static%}
{% load markdown_deux_tags %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Post</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- markdown renderer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#EF7722',
              accent: '#0BA6DF',
              warm: '#FAA533',
              bgsoft: '#F8F8F8',
              neutralText: '#1E1E1E'
            },
            borderRadius: {
              xl2: '18px'
            }
          }
        }
      }
    </script>

    <style>
      body { font-family: 'Inter', sans-serif; }
      .card-shadow { box-shadow: 0 4px 14px rgba(0,0,0,0.06); }
      .hover-card:hover { transform: translateY(-3px); box-shadow: 0 8px 18px rgba(0,0,0,0.08); transition: all 0.18s ease; }
      .glass { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.8); }
      .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 50; align-items: center; justify-content: center; padding: 20px; }
      .modal.active { display: flex; }
      .hide-scroll-bar::-webkit-scrollbar { display: none; }
      .hide-scroll-bar { -ms-overflow-style: none; scrollbar-width: none; }
      .sidebar-icon { transition: all 0.16s ease; }
      .sidebar-icon:hover { color: rgb(239 119 34); transform: scale(1.06); }
      .editor-toolbar button { min-width: 36px; }
      .emoji-grid { max-width: 360px; display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; }
      .emoji-item { cursor: pointer; font-size: 18px; padding: 6px; border-radius: 6px; text-align:center; }
      .emoji-item:hover { background: #f3f4f6; transform: translateY(-2px); }
      .thumb { width:84px; height:84px; object-fit:cover; border-radius:8px; border:1px solid #e5e7eb; }
      .file-chip { font-size: 12px; padding:6px 8px; border-radius:999px; background:#fafafa; border:1px solid #eee; display:inline-flex; gap:8px; align-items:center; }
      .modal-card { max-height: calc(100vh - 80px); overflow:auto; }
      .toolbar-btn { background: white; border: 1px solid #eef2f7; padding:6px; border-radius:8px; }
      .toolbar-btn:hover { background: #f9fafb; }
    </style>
  </head>

  <body class="bg-bgsoft text-neutralText">

    <!-- NAVBAR -->
    <nav class="glass fixed w-full top-0 left-0 z-40 border-b border-gray-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-gradient-to-br from-primary to-warm rounded-lg flex items-center justify-center text-white font-semibold text-base">
              E
            </div>
            <span class="font-semibold text-gray-800 text-lg">Evolv</span>
          </div>

          <div class="hidden md:flex items-center space-x-8">
            <a href="/" class="text-sm font-medium text-gray-600 hover:text-primary transition">Home</a>
            <a href="/planner" class="text-sm font-medium text-gray-600 hover:text-primary transition">Planner</a>
            <a href="#" class="text-sm font-medium text-gray-600 hover:text-primary transition">Grow</a>
            {%if user.is_authenticated%}
              <a href="/in/{{user.profile.slug}}" class="text-sm font-medium text-gray-600 hover:text-primary transition">Profile</a>
            {%else%}
              <a href="/accounts/login" class="text-sm font-medium text-gray-600 hover:text-primary transition">Profile</a>
            {%endif%}
          </div>

          <div class="flex items-center gap-3">
            <input type="text" placeholder="Search..." class="hidden sm:block bg-white border border-gray-200 text-sm px-3 py-1.5 rounded-lg focus:outline-none focus:ring-2 focus:ring-accent w-44 lg:w-60" />
            <button id="openPostModal" class="px-4 py-1.5 bg-primary text-white rounded-lg text-sm font-medium hover:opacity-90 transition">Search</button>
          </div>
        </div>
      </div>
    </nav>

    <!-- LAYOUT -->
    <div class="flex mt-16 max-w-7xl mx-auto">

      <!-- LEFT NAV SIDEBAR -->
      <aside class="w-20 sm:w-24 lg:w-56 h-[calc(100vh-70px)] px-3 py-6 glass border-r border-gray-200 sticky top-16 flex flex-col">
        <div class="flex flex-col gap-4">
          <a href="/" class="flex items-center gap-3 px-2 py-2 text-primary sidebar-icon">
            <i class="fas fa-home text-lg w-6 text-center"></i>
            <span class="hidden lg:inline text-sm font-medium">Home</span>
          </a>

          <a href="/planner" class="flex items-center gap-3 px-2 py-2 text-gray-600 hover:text-primary sidebar-icon">
            <i class="fas fa-calendar-check text-lg w-6 text-center"></i>
            <span class="hidden lg:inline text-sm font-medium">Planner</span>
          </a>

          <a href="#" class="flex items-center gap-3 px-2 py-2 text-gray-600 hover:text-primary sidebar-icon">
            <i class="fas fa-briefcase text-lg w-6 text-center"></i>
            <span class="hidden lg:inline text-sm font-medium">Grow</span>
          </a>

          <a href="/notifications" class="flex items-center gap-3 px-2 py-2 text-gray-600 hover:text-primary font-medium sidebar-icon">
              <i class="fas fa-bell text-lg w-6 text-center"></i>
              <span class="hidden lg:inline text-sm">Notifications</span>
          </a>

          <a href="/chats" class="flex items-center gap-3 px-2 py-2 text-gray-600 hover:text-primary sidebar-icon">
            <i class="fas fa-comments text-lg w-6 text-center"></i>
            <span class="hidden lg:inline text-sm font-medium">Chats</span>
          </a>
        </div>

        <div class="mt-auto">
          <!-- Profile summary (compact) -->
          {%if user.is_authenticated%}
            <div class="hidden lg:flex items-center gap-3 p-3 rounded-xl2 bg-white card-shadow">
              {%if user.profile.profile_pic%}
                <img src="{{user.profile.profile_pic.url}}" class="w-10 h-10 rounded-full object-cover">
              {%else%}
                <img src="{%static 'imgs/profile_placeholder.png'%}" class="w-10 h-10 rounded-full object-cover">
              {%endif%}
              <div>
                <div class="text-sm font-medium">{{user.first_name}}</div>
                <div class="text-xs text-gray-500">{{user.profile.job_title}}</div>
              </div>
            </div>
          {%else%}
            <div class="hidden lg:flex items-center gap-3 p-3 rounded-xl2 bg-white card-shadow">
              <img src="{%static 'imgs/profile_placeholder.png'%}" class="w-10 h-10 rounded-full object-cover">
              <div>
                <div class="text-sm font-medium">User Name</div>
                <div class="text-xs text-gray-500">Job Title</div>
              </div>
            </div>
          {%endif%}
          <div class="mt-4 px-2">
            <a href="/settings" class="flex items-center gap-3 text-gray-500 hover:text-primary sidebar-icon">
              <i class="fas fa-cog text-lg w-6 text-center"></i>
              <span class="hidden lg:inline text-sm font-medium">Settings</span>
            </a>
          </div>
        </div>
      </aside>

      <!-- MAIN CONTENT (FEED) -->
      <main class="flex-1 p-6 space-y-6 lg:col-span-7">
        <!-- Stories -->
        
        <!-- <div class="bg-white rounded-xl2 p-4 card-shadow flex overflow-x-auto gap-4 hide-scroll-bar">
          <div class="flex gap-4">
            <div class="flex flex-col items-center text-center min-w-[70px]">
              <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-accent to-primary p-1">
                <img src="images/profile.jpg" class="rounded-full border-2 border-white w-full h-full">
              </div>
              <p class="text-xs mt-1 text-gray-600">You</p>
            </div>
            <div class="flex flex-col items-center text-center min-w-[70px]">
              <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-accent to-primary p-1">
                <img src="images/sara.jpg" class="rounded-full border-2 border-white w-full h-full">
              </div>
              <p class="text-xs mt-1 text-gray-600">Sarah</p>
            </div>
            <div class="flex flex-col items-center text-center min-w-[70px]">
              <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-accent to-primary p-1">
                <img src="images/omar.jpg" class="rounded-full border-2 border-white w-full h-full">
              </div>
              <p class="text-xs mt-1 text-gray-600">Omar</p>
            </div>
          </div>
        </div> -->

        <!-- post -->
        <article class="bg-white rounded-xl2 p-5 card-shadow hover-card space-y-3">
          <a href="/in/{{post.owner.slug}}" class="flex items-center gap-3">
            {%if post.owner.profile_pic%}
              <img src="{{post.owner.profile_pic.url}}" class="w-10 h-10 rounded-full">
            {%else%}
              <img src="{%static 'imgs/profile_placeholder.png'%}" class="w-10 h-10 rounded-full">
            {%endif%}
            <div>
              <div class="font-medium text-sm">{{post.owner.user.first_name}}</div>
              <div class="text-xs text-gray-500">{{post.date|timesince}} â€¢ ago | {{post.audience}}</div>
            </div>
          </a>
          <p class="text-base text-gray-800 leading-relaxed">
            {{post.text|markdown}}
          </p>
          {%if post.poster%}
          <img src="{{post.poster.url}}" class="rounded-lg w-full object-cover">
          {%endif%}
          <div class="flex items-center justify-between pt-3 text-sm text-gray-500">
            <div class="flex items-center gap-6">
              <a href="/post/{{post.id}}/like">
                <button class="hover:text-primary flex items-center gap-1 transition">
                  {%if user.is_authenticated and user.profile in post.likes.all%}
                    <i onclick="this.style.color='#a0aec0'" style="color: red;" class="fa-regular fa-heart"></i> 
                  {%else%}
                    <i onclick="this.style.color='red'" class="fa-regular fa-heart"></i> 
                  {%endif%}
                  <span>{{post.likes.count}}</span>
                </button>
              </a>
              <button class="hover:text-accent flex items-center gap-1 transition">
                <i class="fa-regular fa-comment"></i> <span>{{post.comment_set.count}}</span>
              </button>
            </div>
            <button class="hover:text-gray-700 transition flex items-center gap-1">
              <i class="fa-solid fa-share"></i> Share
            </button>
          </div>
        </article>
        <!-- Comments Section -->
        <div class="border-t pt-4 mt-4 space-y-5">
          <h3 class="text-sm font-semibold text-gray-700">Comments ({{ post.comment_set.count }})</h3>

          <!-- Existing Comments -->
          <div class="space-y-4">
            {% for comment in post.comment_set.all %}
            <div class="flex items-start gap-3">
              {% if comment.owner.profile_pic %}
                <img src="{{ comment.owner.profile_pic.url }}" class="w-9 h-9 rounded-full object-cover">
              {% else %}
                <img src="{% static 'imgs/profile_placeholder.png' %}" class="w-9 h-9 rounded-full object-cover">
              {% endif %}

              <div class="flex-1 bg-gray-50 p-3 rounded-lg border border-gray-100">
                <div class="flex justify-between items-center">
                  <div>
                    <div class="font-medium text-sm text-gray-800">{{ comment.owner.user.first_name }}</div>
                    <div class="text-xs text-gray-500">{{ comment.date|timesince }} ago</div>
                  </div>
                  {% if comment.owner == user.profile %}
                    <a href="/post/{{post.id}}/comment/{{comment.id}}/delete" class="text-xs text-gray-400 hover:text-red-500">
                      <i class="fa-solid fa-trash"></i>
                    </a>
                  {% endif %}
                </div>
                <p class="text-sm text-gray-700 mt-1">{{ comment.text|markdown }}</p>
              </div>
            </div>
            {% empty %}
            <p class="text-sm text-gray-500">No comments yet â€” be the first to share your thoughts.</p>
            {% endfor %}
          </div>
          <!-- Add Comment Form -->
          {% if user.is_authenticated %}
          <form method="POST" enctype="multipart/form-data" class="flex items-start gap-3 mt-3">
            {% csrf_token %}
            {% if user.profile.profile_pic %}
              <img src="{{ user.profile.profile_pic.url }}" class="w-9 h-9 rounded-full object-cover">
            {% else %}
              <img src="{% static 'imgs/profile_placeholder.png' %}" class="w-9 h-9 rounded-full object-cover">
            {% endif %}
            <div class="flex-1">
              <textarea name="text" rows="2" placeholder="Write a comment..." 
                class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent resize-none"></textarea>
              <div class="flex justify-end mt-2">
                <button type="submit" class="px-4 py-1.5 bg-accent text-white text-sm rounded-lg hover:opacity-90 transition">
                  Comment
                </button>
              </div>
            </div>
          </form>
          {% else %}
          <div class="mt-3 text-sm text-gray-600">
            <a href="/accounts/login" class="text-accent hover:underline">Log in</a> to post a comment.
          </div>
          {% endif %}
        </div>
      </main>

      <!-- RIGHT SIDEBAR: PROFILE CARD + FOLLOWERS -->
      <aside class="hidden lg:block lg:col-span-3 w-80 px-4 py-6">
        <!-- Profile card -->
        {%if user.is_authenticated%}
        <div class="bg-gradient-to-br from-white to-bgsoft rounded-xl2 p-5 card-shadow hover-card mb-4">
          <div class="flex flex-col items-center text-center">
            {%if user.profile.profile_pic%}
              <img src="{{user.profile.profile_pic.url}}" class="w-20 h-20 rounded-full object-cover shadow-md">
            {%else%}
              <img src="{%static 'imgs/profile_placeholder.png'}" class="w-20 h-20 rounded-full object-cover shadow-md">
            {%endif%}
            <div class="mt-3 font-semibold text-gray-800 text-base">{{user.first_name}}</div>
            <div class="text-xs text-gray-500 mb-2">{{user.profile.job_title}}</div>
            <p class="text-sm text-gray-600 leading-relaxed max-w-[220px]">{{user.profile.bio}}</p>
            <div class="mt-4 border-t pt-3 flex justify-between w-full text-xs text-gray-500">
              <div><strong class="text-primary">{{user.profile.followers.count}}</strong> Followers</div>
              <div><strong class="text-primary">{{user.profile.following.count}}</strong> Following</div>
            </div>
          </div>
        </div>
        {%else%}
        <div class="bg-gradient-to-br from-white to-bgsoft rounded-xl2 p-5 card-shadow hover-card mb-4">
          <div class="flex flex-col items-center text-center">
            <img src="{%static 'imgs/profile_placeholder.png'%}" class="w-20 h-20 rounded-full object-cover shadow-md">
            <div class="mt-3 font-semibold text-gray-800 text-base">Username</div>
            <div class="text-xs text-gray-500 mb-2">Job Title</div>
            <p class="text-sm text-gray-600 leading-relaxed max-w-[220px]">Bio</p>
            <div class="mt-4 border-t pt-3 flex justify-between w-full text-xs text-gray-500">
              <div><strong class="text-primary">0</strong> Followers</div>
              <div><strong class="text-primary">0</strong> Following</div>
            </div>
          </div>
        </div>
        {%endif%}
        <!-- Followers (small list) -->

        <div class="bg-white rounded-xl2 p-5 card-shadow">
          <div class="flex items-center justify-between mb-3">
            <div class="font-medium text-sm text-gray-600">Followers</div>
            <a href="#" class="text-xs text-accent hover:underline">See all</a>
          </div>
          {%for follower in user.profile.followers.all%}
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                {%if follower.profile_pic%}
                  <img src="{{follower.profile_pic.url}}" class="w-9 h-9 rounded-full">
                {%else%}
                  <img src="{%static 'imgs/profile_placeholder.png'%}" class="w-9 h-9 rounded-full">
                {%endif%}
                <div>
                  <div class="text-sm font-medium">{{follower.profile.user.first_name}}</div>
                  <div class="text-xs text-gray-500">{{follower.job_title}}</div>
                </div>
              </div>
              {%if not user.profile in follower.followers.all%}
                <a href="in/{{follower.slug}}/follow"><button class="text-xs bg-accent text-white px-2.5 py-1 rounded-lg hover:opacity-90">Follow</button></a>
              {%else%}
                <a href="in/{{follower.slug}}/follow"><button class="text-xs bg-primary text-white px-2.5 py-1 rounded-lg hover:opacity-90">Unfollow</button></a>
              {%endif%}
            </div> 
            {%endfor%}
            </div>
          </div>
        </div>
      </aside>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const NotifIcon = document.querySelector('.fa-bell');
        const chatIcon = document.querySelector('.fa-comments');

        function updateUnreadCounts() {
          fetch("/api/unread_counts/")
            .then(response => response.json())
            .then(data => {
              const notifCount = data.notifications;
              const msgCount = data.messages;

              // optionally add a badge for messages
              if (chatIcon) {
                let msgBadge = chatIcon.parentElement.querySelector('.msg-badge');
                if (!msgBadge) {
                  msgBadge = document.createElement('span');
                  msgBadge.className = 'msg-badge';
                  chatIcon.parentElement.style.position = 'relative';
                  chatIcon.parentElement.appendChild(msgBadge);
                }
                msgBadge.className = 'absolute -top-1 -left-1 bg-red-500 text-white text-[10px] font-bold px-1.5 rounded-full';
                msgBadge.textContent = msgCount > 0 ? msgCount : '';
                msgBadge.style.display = msgCount > 0 ? 'inline-block' : 'none';
              }
              if (NotifIcon) {
                let notifBadge = NotifIcon.parentElement.querySelector('.notif-badge');
                if (!notifBadge) {
                  notifBadge = document.createElement('span');
                  notifBadge.className = 'notif-badge';
                  NotifIcon.parentElement.style.position = 'relative';
                  NotifIcon.parentElement.appendChild(notifBadge);
                }
                notifBadge.className = 'absolute -top-1 -left-1 bg-red-500 text-white text-[10px] font-bold px-1.5 rounded-full';
                notifBadge.textContent = notifCount > 0 ? notifCount : '';
                notifBadge.style.display = notifCount > 0 ? 'inline-block' : 'none';
              }
            })
            .catch(err => console.error('Error fetching unread counts:', err));
        }

        // Fetch immediately, then every 20 seconds
        updateUnreadCounts();
        setInterval(updateUnreadCounts, 20000);
      });
      </script>
      <script>
        document.addEventListener("DOMContentLoaded", function () {
          document.querySelectorAll('.fa-share').forEach(btn => {
            btn.addEventListener('click', function (e) {
              e.preventDefault();
              const postElement = btn.closest('article');
              const postId = "{{post.id}}"
              const shareUrl = `${window.location.origin}/post/${postId}`;
              
              if (navigator.share) {
                navigator.share({
                  title: 'Check out this post on Evolv',
                  url: shareUrl
                }).catch(err => console.log('Share canceled', err));
              } else {
                navigator.clipboard.writeText(shareUrl).then(() => {
                  alert('Post link copied to clipboard!');
                });
              }
            });
          });
        });
        </script>
  </body>
</html>
